<!DOCTYPE HTML>
<html>

	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<title>顺庆区区委办督查督办管理系统</title>
		<link rel="stylesheet" href="../css/iview.css">
		<link rel="stylesheet" href="../css/load.css">
		<script src="../js/vue.min.js"></script>
		<script type="text/javascript" src="../lib/jquery/1.9.1/jquery.min.js"></script>
		<script type="text/javascript" src="../lib/layer/2.4/layer.js"></script>
		<script src="../js/url.js"></script>
		<script src="../js/axios.min.js"></script>
		<script src="../js/axiosConfig.js"></script>
		<script src="../js/iview.min.js"></script>

	</head>

	<body>
		<div id="app" style="margin:15px 10px 10px 10px;">
			<i-table border :columns="columns6" :data="data5" class='main-list'>
			</i-table>
			<Page :total="pageTotal" :current="pageNum" :page-size="pageSize" show-elevator show-sizer show-total placement="top" @on-change="handlePage" @on-page-size-change='handlePageSize'></Page>
		</div>
		<script type="text/javascript" src="../lib/layer/2.4/layer.js"></script>
		<script>
			var type = request("type");
			var myVue = new Vue({
				el: '#app',
				data: {
					qqq: "1",
					pageTotal: 0,
					pageNum: 1,
					pageSize: 10,
					columns6: [],
					data5: [],
					departmentList: [],
					// 查询条件
					paramData: {
						beforeTime: '',
						afterTime: '',
						id: '',
						companyIds: [],
						limit: 10,
						page: 1
					},
					qqq:type
				},
				mounted: function() {
					this.checkitem();
				},
				methods: {
					//获取信息监督项目列表
					checkitem() {
						var vm = this;
						$.Apiaxios({
							url: apiUrl.ApiCheckItemList + '?itemclass=4',
							method: "GET",
							content: "获取数据中，请稍等...",
							success: function(ret) {
								vm.modelCheckItem = [];
								vm.columns6 = [

									{
										title: '上报时间',
										key: 'mtime',
										sortable: true
									},
									{
										title: '上报名称',
										key: 'mtile',
										sortable: true
									},
									{
										title: '部门单位',
										key: 'ctitle',
										sortable: true
									},

								]
								$(ret.data).each(function(index, item) {
									var tempitem = {};
									tempitem.title = item.itemdesc;
									tempitem.key = item.id;
									tempitem.sortable = true;
									vm.columns6.push(tempitem);
									vm.modelCheckItem.push(tempitem);
								});
								var optitem = {
									title: '操作',
									key: 'action',
									width: 150,
									align: 'center',
									render: (h, params) => {
										return h('div', [
											h('Button', {
												props: {
													type: 'primary',
													size: 'small'
												},
												style: {
													marginRight: '5px'
												},
												on: {
													click: () => {
														CheckDetail(params.row.mid, params.row.unitid,vm.qqq);
													}
												}
											}, '编辑'),
											h('Button', {
												props: {
													type: 'error',
													size: 'small',
												},
												on: {
													click: () => {
														// console.log(params.index)
														layer.confirm(
															'确认删除吗', {
																icon: 3,
																title: '提示'
															},
															function(index) {
																//yes
																//do something
																layer.close(index);
																$.Apiaxios({
																	url: apiUrl.Apiinfosdelete,
																	method: "POST",
																	data: {
																		unitid: vm.data5[params.index].unitid,
																		infosid: vm.data5[params.index].mid
																	},
																	content: "获取数据中，请稍等...",
																	success: function(ret) {
																		// console.log(ret)
																		if(ret.success == true) {
																			layer.msg(ret.message);
																			$('.main-list .ivu-table-row').eq(params.index).remove();
																		} else {
																			vm.$Message.warning(ret.message);
																		}
																	}
																})
															},
															function(index) {
																//no
																layer.close(index);
															}
														);
													}
												}
											}, '删除'),

										]);
									}
								};
								var optitem1 = {
									title: '操作',
									key: 'action',
									width: 150,
									align: 'center',
									render: (h, params) => {
										return h('div', [
											h('Button', {
												props: {
													type: 'primary',
													size: 'small'
												},
												style: {
													marginRight: '5px'
												},
												on: {
													click: () => {
														CheckDetail(params.row.mid, params.row.unitid,vm.qqq);
													}
												}
											}, '查看'),

										]);
									}
								};
								if (vm.qqq == "1") {
									vm.columns6.push(optitem);
								}else if (vm.qqq == "2") {
									vm.columns6.push(optitem1);
								}
								vm.getinfoslist(vm.paramData);

							}
						});

					},

					//获取单位信息监督项目列表
					getinfoslist(paramData) {
						var id = request('id');
						var vm = this;
						paramData.limit = vm.pageSize;
						paramData.id = id;
						paramData.page = vm.pageNum;
						$.Apiaxios({
							url: apiUrl.Apiinfoslist,
							method: "post",
							data: paramData,
							content: "查询数据中，请稍等...",
							success: function(ret) {
								var infolist = ret.data.records; //信息部门列表数据
								vm.pageTotal = ret.data.total;
								if(ret.success) {
									var infolist = ret.data.records; //信息部门列表数据
									vm.pageTotal = ret.data.total;
									var outputdata = [];
									$(infolist).each(function(index, item) {
										var mtile = item.title;
										var mtime = item.mtime;
										var mid = item.id;
										var mtime = mtime.substring(0, 10);
										$(item.companys).each(function(indexmx, itemmx) {
											itemmx.mtime = mtime;
											itemmx.mtile = mtile;
											itemmx.mid = mid;
											outputdata.push(itemmx);
										});
									});
									vm.data5 = outputdata;
									//                                  console.log(vm.data5)
								} else {
									vm.data5 = [];
									vm.$Message.warning(ret.message);
								}
							}
						});
					},
					handlePage(value) {
						this.pageNum = value;
						this.getinfoslist(this.paramData);
						this.pageNum = 1;
					},
					handlePageSize(value) {
						this.pageSize = value;
						this.getinfoslist(this.paramData);
					},
				}
			});

			function CheckDetail(id, unitid,type) {
				layerindex = layer.open({
					type: 2,
					title: "编辑",
					maxmin: true,
					area: ['900px', '400px'], //弹出层页面比例
					content: "bianji.html?id=" + id + "&unitid=" + unitid +"&type="+type
				});
			}
		</script>
	</body>

</html>